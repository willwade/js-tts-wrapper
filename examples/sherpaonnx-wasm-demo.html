<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SherpaOnnx WebAssembly TTS Demo</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      line-height: 1.6;
    }
    h1 {
      color: #333;
      border-bottom: 2px solid #eee;
      padding-bottom: 10px;
    }
    .container {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    .card {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    .controls {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    .control-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    label {
      font-weight: bold;
      color: #555;
    }
    textarea {
      width: 100%;
      height: 120px;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-family: inherit;
      resize: vertical;
    }
    select, input[type="range"] {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .button-group {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
    button {
      padding: 10px 15px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      transition: background-color 0.3s;
    }
    button:hover {
      background-color: #45a049;
    }
    button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
    button.secondary {
      background-color: #f44336;
    }
    button.secondary:hover {
      background-color: #d32f2f;
    }
    button.tertiary {
      background-color: #2196F3;
    }
    button.tertiary:hover {
      background-color: #0b7dda;
    }
    .status {
      margin-top: 20px;
      padding: 15px;
      border-radius: 4px;
      background-color: #f9f9f9;
      border-left: 4px solid #2196F3;
    }
    .log {
      margin-top: 20px;
      height: 200px;
      overflow-y: auto;
      padding: 10px;
      background-color: #f5f5f5;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-family: monospace;
      white-space: pre-wrap;
    }
    .property-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
    }
    .property-control {
      flex: 1;
      min-width: 200px;
    }
    .range-value {
      text-align: center;
      font-weight: bold;
      margin-top: 5px;
    }
    .loading {
      text-align: center;
      padding: 20px;
      font-style: italic;
      color: #666;
    }
    .hidden {
      display: none;
    }
    .footer {
      margin-top: 30px;
      text-align: center;
      font-size: 0.9em;
      color: #666;
    }
  </style>
</head>
<body>
  <h1>SherpaOnnx WebAssembly TTS Demo</h1>

  <div class="container">
    <div id="loading" class="loading">
      Loading SherpaOnnx WebAssembly module... This may take a moment.
    </div>

    <div id="content" class="hidden">
      <div class="card">
        <div class="controls">
          <div class="control-group">
            <label for="voice">Voice:</label>
            <select id="voice"></select>
          </div>

          <div class="control-group">
            <label for="text">Text to speak:</label>
            <textarea id="text">Hello! This is a demonstration of the SherpaOnnx WebAssembly Text-to-Speech engine. It runs entirely in your browser without sending any data to external servers.</textarea>
          </div>

          <div class="property-controls">
            <div class="property-control">
              <label for="rate">Rate:</label>
              <input type="range" id="rate" min="0.5" max="2.0" step="0.1" value="1.0">
              <div id="rate-value" class="range-value">1.0</div>
            </div>

            <div class="property-control">
              <label for="pitch">Pitch:</label>
              <input type="range" id="pitch" min="0.5" max="2.0" step="0.1" value="1.0">
              <div id="pitch-value" class="range-value">1.0</div>
            </div>

            <div class="property-control">
              <label for="volume">Volume:</label>
              <input type="range" id="volume" min="0.0" max="2.0" step="0.1" value="1.0">
              <div id="volume-value" class="range-value">1.0</div>
            </div>
          </div>

          <div class="button-group">
            <button id="speak" disabled>Speak</button>
            <button id="stop" class="secondary" disabled>Stop</button>
            <button id="download" class="tertiary" disabled>Download as WAV</button>
          </div>
        </div>
      </div>

      <div class="status" id="status">
        Status: Ready
      </div>

      <div class="log" id="log"></div>
    </div>
  </div>

  <div class="footer">
    Powered by <a href="https://github.com/willwade/js-tts-wrapper" target="_blank">js-tts-wrapper</a> and <a href="https://github.com/k2-fsa/sherpa-onnx" target="_blank">SherpaOnnx</a>
  </div>

  <!-- Load the JS TTS Wrapper library -->
  <script type="module">
    // Import the library
    import { SherpaOnnxWasmTTSClient } from './js-tts-wrapper.browser.bundle.js';

    // DOM elements
    const loadingElement = document.getElementById('loading');
    const contentElement = document.getElementById('content');
    const voiceSelect = document.getElementById('voice');
    const textArea = document.getElementById('text');
    const rateInput = document.getElementById('rate');
    const pitchInput = document.getElementById('pitch');
    const volumeInput = document.getElementById('volume');
    const rateValueElement = document.getElementById('rate-value');
    const pitchValueElement = document.getElementById('pitch-value');
    const volumeValueElement = document.getElementById('volume-value');
    const speakButton = document.getElementById('speak');
    const stopButton = document.getElementById('stop');
    const downloadButton = document.getElementById('download');
    const statusElement = document.getElementById('status');
    const logElement = document.getElementById('log');

    // TTS client
    let ttsClient;
    let voices = [];
    let isPlaying = false;

    // Log function
    function log(message) {
      const timestamp = new Date().toLocaleTimeString();
      logElement.innerHTML += `[${timestamp}] ${message}\n`;
      logElement.scrollTop = logElement.scrollHeight;
    }

    // Update status
    function updateStatus(message) {
      statusElement.textContent = `Status: ${message}`;
    }

    // Initialize the TTS client
    async function initTTS() {
      try {
        log('Creating SherpaOnnx WebAssembly TTS client...');

        // Create a new SherpaOnnx WebAssembly TTS client
        ttsClient = new SherpaOnnxWasmTTSClient();

        log('Initializing WebAssembly module...');

        // Initialize the WebAssembly module
        // The path should point to where the WebAssembly files are located
        await ttsClient.initializeWasm('../public/sherpaonnx-wasm/sherpa-onnx-wasm-main-tts.js');

        log('Loading voices...');

        // Get available voices
        voices = await ttsClient.getVoices();
        log(`Found ${voices.length} voices`);

        // Populate voice selector
        voices.forEach(voice => {
          const option = document.createElement('option');
          option.value = voice.id;
          option.textContent = `${voice.name} (${voice.languageCodes[0].display})`;
          voiceSelect.appendChild(option);
        });

        // Set initial voice
        if (voices.length > 0) {
          await ttsClient.setVoice(voices[0].id);
          log(`Selected voice: ${voices[0].name}`);
        }

        // Enable controls
        speakButton.disabled = false;
        stopButton.disabled = true;
        downloadButton.disabled = false;

        // Show content
        loadingElement.classList.add('hidden');
        contentElement.classList.remove('hidden');

        updateStatus('Ready');
        log('TTS client initialized successfully');

        // Set up event listeners for property changes
        rateInput.addEventListener('input', () => {
          const value = parseFloat(rateInput.value);
          rateValueElement.textContent = value.toFixed(1);
          ttsClient.setProperty('rate', value);
        });

        pitchInput.addEventListener('input', () => {
          const value = parseFloat(pitchInput.value);
          pitchValueElement.textContent = value.toFixed(1);
          ttsClient.setProperty('pitch', value);
        });

        volumeInput.addEventListener('input', () => {
          const value = parseFloat(volumeInput.value);
          volumeValueElement.textContent = value.toFixed(1);
          ttsClient.setProperty('volume', value);
        });

      } catch (error) {
        log(`Error initializing TTS client: ${error.message}`);
        console.error('Error initializing TTS client:', error);
        updateStatus('Error: Failed to initialize TTS');
        loadingElement.textContent = 'Failed to load SherpaOnnx WebAssembly module. Please check the console for details.';
      }
    }

    // Speak function
    async function speak() {
      try {
        const text = textArea.value;
        const voiceId = voiceSelect.value;

        if (!text) {
          log('Please enter some text to speak');
          return;
        }

        // Disable speak button and enable stop button
        speakButton.disabled = true;
        stopButton.disabled = false;
        isPlaying = true;

        log(`Speaking: "${text.substring(0, 50)}${text.length > 50 ? '...' : ''}" with voice ${voiceId}`);
        updateStatus('Speaking...');

        // Set up event handlers
        ttsClient.on('start', () => {
          log('Speech started');
        });

        ttsClient.on('end', () => {
          log('Speech completed');
          updateStatus('Ready');
          speakButton.disabled = false;
          stopButton.disabled = true;
          isPlaying = false;
        });

        ttsClient.on('word', (time, word) => {
          log(`Word: "${word}" at ${time.toFixed(2)}s`);
        });

        // Set the voice
        await ttsClient.setVoice(voiceId);

        // Speak the text
        await ttsClient.speak(text);

      } catch (error) {
        log(`Error speaking: ${error.message}`);
        console.error('Error speaking:', error);
        updateStatus('Error: Failed to speak');
        speakButton.disabled = false;
        stopButton.disabled = true;
        isPlaying = false;
      }
    }

    // Stop function
    function stop() {
      try {
        ttsClient.stop();
        log('Speech stopped');
        updateStatus('Ready');
        speakButton.disabled = false;
        stopButton.disabled = true;
        isPlaying = false;
      } catch (error) {
        log(`Error stopping speech: ${error.message}`);
        console.error('Error stopping speech:', error);
      }
    }

    // Download function
    async function download() {
      try {
        const text = textArea.value;
        const voiceId = voiceSelect.value;

        if (!text) {
          log('Please enter some text to download');
          return;
        }

        log(`Generating audio file for: "${text.substring(0, 50)}${text.length > 50 ? '...' : ''}"`);
        updateStatus('Generating audio file...');

        // Disable buttons
        downloadButton.disabled = true;

        // Set the voice
        await ttsClient.setVoice(voiceId);

        // Generate audio file
        await ttsClient.synthToFile(text, 'tts-output.wav');

        log('Audio file generated and download started');
        updateStatus('Ready');

        // Re-enable buttons
        downloadButton.disabled = false;

      } catch (error) {
        log(`Error generating audio file: ${error.message}`);
        console.error('Error generating audio file:', error);
        updateStatus('Error: Failed to generate audio file');
        downloadButton.disabled = false;
      }
    }

    // Event listeners
    speakButton.addEventListener('click', speak);
    stopButton.addEventListener('click', stop);
    downloadButton.addEventListener('click', download);

    // Initialize TTS when the page loads
    window.addEventListener('DOMContentLoaded', initTTS);
  </script>
</body>
</html>
