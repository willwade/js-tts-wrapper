<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SherpaOnnx WebAssembly TTS - Default Example</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    h1 {
      color: #333;
    }
    textarea {
      width: 100%;
      height: 100px;
      margin-bottom: 10px;
    }
    button {
      padding: 10px 15px;
      background-color: #4CAF50;
      color: white;
      border: none;
      cursor: pointer;
      margin-right: 10px;
    }
    button:hover {
      background-color: #45a049;
    }
    #status {
      margin-top: 20px;
      padding: 10px;
      background-color: #f8f8f8;
      border-left: 4px solid #4CAF50;
    }
    pre {
      background-color: #f5f5f5;
      padding: 10px;
      border-radius: 5px;
      overflow-x: auto;
    }
    .clip {
      margin-top: 20px;
      padding: 10px;
      background-color: #f8f8f8;
      border-radius: 5px;
    }
    .delete {
      background-color: #f44336;
    }
  </style>
</head>
<body>
  <h1>SherpaOnnx WebAssembly TTS - Default Example</h1>
  
  <div>
    <label for="speakerId" id="speakerIdLabel">Speaker ID: </label>
    <input type="text" id="speakerId" name="speakerId" value="0" />
    <br/>
    <br/>
    <label for="speed" id="speedLabel">Speed: </label>
    <input type="range" id="speed" name="speed" min="0.4" max="3.5" step="0.1" value="1.0" />
    <span id="speedValue"></span>
    <br/>
    <br/>
    <textarea id="text" rows="10" placeholder="Please enter your text here and click the Generate button">Hello, this is a test of the SherpaOnnx WebAssembly text-to-speech engine.</textarea>
    <br/>
    <br/>
    <button id="generateBtn" disabled>Generate</button>
  </div>
  
  <div id="status">Loading...</div>
  
  <section id="sound-clips">
  </section>
  
  <script>
    // Get DOM elements
    const generateBtn = document.getElementById('generateBtn');
    const speakerIdLabel = document.getElementById('speakerIdLabel');
    const speakerIdInput = document.getElementById('speakerId');
    const speedInput = document.getElementById('speed');
    const speedValue = document.getElementById('speedValue');
    const textArea = document.getElementById('text');
    const soundClips = document.getElementById('sound-clips');
    
    // Initialize speed value display
    speedValue.innerHTML = speedInput.value;
    
    // Variables
    let index = 0;
    let tts = null;
    let audioCtx = null;
    
    // Define the Module object
    Module = {};
    
    // Set up the Module locateFile function
    Module.locateFile = function(path, scriptDirectory = '') {
      console.log(`path: ${path}, scriptDirectory: ${scriptDirectory}`);
      return scriptDirectory + path;
    };
    
    // Set up the Module setStatus function
    Module.setStatus = function(status) {
      console.log(`status ${status}`);
      const statusElement = document.getElementById('status');
      if (status == "Running...") {
        status = 'Model downloaded. Initializing text to speech model...'
      }
      statusElement.textContent = status;
      if (status === '') {
        statusElement.style.display = 'none';
      } else {
        statusElement.style.display = 'block';
      }
    };
    
    // Set up the Module onRuntimeInitialized function
    Module.onRuntimeInitialized = function() {
      console.log('Model files downloaded!');
      
      // Wait for the Module to be fully initialized
      const checkModuleReady = () => {
        if (Module.calledRun) {
          console.log('Module is fully initialized (calledRun is true)');
          initTTS();
        } else {
          console.log('Waiting for Module to be fully initialized (calledRun is false)...');
          setTimeout(checkModuleReady, 500);
        }
      };
      
      checkModuleReady();
    };
    
    // Initialize TTS
    function initTTS() {
      console.log('Initializing tts ......');
      
      try {
        // Create TTS instance with default configuration
        tts = createOfflineTts(Module);
        console.log('TTS initialized');
        console.log(`Sample rate: ${tts.sampleRate}`);
        console.log(`Number of speakers: ${tts.numSpeakers}`);
        
        // Update speaker ID label if there are multiple speakers
        if (tts.numSpeakers > 1) {
          speakerIdLabel.innerHTML = `Speaker ID (0 - ${tts.numSpeakers - 1}):`;
        }
        
        // Enable generate button
        generateBtn.disabled = false;
        
        // Initialize audio context
        audioCtx = new (window.AudioContext || window.webkitAudioContext)({sampleRate: tts.sampleRate});
      } catch (error) {
        console.error('Error initializing TTS:', error);
        document.getElementById('status').textContent = 'Error initializing TTS: ' + error.message;
      }
    }
    
    // Handle speed input change
    speedInput.oninput = function() { 
      speedValue.innerHTML = this.value; 
    };
    
    // Handle generate button click
    generateBtn.onclick = function() {
      let speakerId = speakerIdInput.value;
      if (speakerId.trim().length == 0) {
        alert('Please input a speakerId');
        return;
      }
      
      if (!speakerId.match(/^\d+$/)) {
        alert(`Input speakerID ${
            speakerId} is not a number.\nPlease enter a number between 0 and ${
            tts.numSpeakers - 1}`);
        return;
      }
      speakerId = parseInt(speakerId, 10);
      if (speakerId > tts.numSpeakers - 1) {
        alert(`Pleaser enter a number between 0 and ${tts.numSpeakers - 1}`);
        return;
      }
      
      let text = textArea.value.trim();
      if (text.length == 0) {
        alert('Please input a non-blank text');
        return;
      }
      
      console.log('speakerId', speakerId);
      console.log('speed', speedInput.value);
      console.log('text', text);
      
      let audio =
          tts.generate({text : text, sid : speakerId, speed : speedInput.value});
      
      console.log(audio.samples.length, audio.sampleRate);
      
      if (!audioCtx) {
        audioCtx = new AudioContext({sampleRate : tts.sampleRate});
      }
      
      const buffer = audioCtx.createBuffer(1, audio.samples.length, tts.sampleRate);
      
      const ptr = buffer.getChannelData(0);
      for (let i = 0; i < audio.samples.length; i++) {
        ptr[i] = audio.samples[i];
      }
      const source = audioCtx.createBufferSource();
      source.buffer = buffer;
      source.connect(audioCtx.destination);
      source.start();
      
      createAudioTag(audio);
    };
    
    // Create audio tag for playback
    function createAudioTag(generateAudio) {
      const blob = toWav(generateAudio.samples, generateAudio.sampleRate);
      
      const text = textArea.value.trim().substring(0, 100);
      const clipName = `${index} ${text} ...`;
      index += 1;
      
      const clipContainer = document.createElement('article');
      const clipLabel = document.createElement('p');
      const audio = document.createElement('audio');
      const deleteButton = document.createElement('button');
      clipContainer.classList.add('clip');
      audio.setAttribute('controls', '');
      deleteButton.textContent = 'Delete';
      deleteButton.className = 'delete';
      
      clipLabel.textContent = clipName;
      
      clipContainer.appendChild(audio);
      
      clipContainer.appendChild(clipLabel);
      clipContainer.appendChild(deleteButton);
      soundClips.appendChild(clipContainer);
      
      audio.controls = true;
      
      const audioURL = window.URL.createObjectURL(blob);
      audio.src = audioURL;
      
      deleteButton.onclick = function(e) {
        let evtTgt = e.target;
        evtTgt.parentNode.parentNode.removeChild(evtTgt.parentNode);
      };
      
      clipLabel.onclick = function() {
        const existingName = clipLabel.textContent;
        const newClipName = prompt('Enter a new name for your sound clip?');
        if (newClipName === null) {
          clipLabel.textContent = existingName;
        } else {
          clipLabel.textContent = newClipName;
        }
      };
    }
    
    // Convert float samples to WAV format
    function toWav(floatSamples, sampleRate) {
      let samples = new Int16Array(floatSamples.length);
      for (let i = 0; i < samples.length; ++i) {
        let s = floatSamples[i];
        if (s >= 1)
          s = 1;
        else if (s <= -1)
          s = -1;
        
        samples[i] = s * 32767;
      }
      
      let buf = new ArrayBuffer(44 + samples.length * 2);
      var view = new DataView(buf);
      
      // http://soundfile.sapp.org/doc/WaveFormat/
      //                   F F I R
      view.setUint32(0, 0x46464952, true);              // chunkID
      view.setUint32(4, 36 + samples.length * 2, true); // chunkSize
      //                   E V A W
      view.setUint32(8, 0x45564157, true); // format
                                           //
      //                      t m f
      view.setUint32(12, 0x20746d66, true);         // subchunk1ID
      view.setUint32(16, 16, true);                 // subchunk1Size, 16 for PCM
      view.setUint32(20, 1, true);                  // audioFormat, 1 for PCM
      view.setUint16(22, 1, true);                  // numChannels: 1 channel
      view.setUint32(24, sampleRate, true);         // sampleRate
      view.setUint32(28, sampleRate * 2, true);     // byteRate
      view.setUint16(32, 2, true);                  // blockAlign
      view.setUint16(34, 16, true);                 // bitsPerSample
      view.setUint32(36, 0x61746164, true);         // Subchunk2ID
      view.setUint32(40, samples.length * 2, true); // subchunk2Size
      
      let offset = 44;
      for (let i = 0; i < samples.length; ++i) {
        view.setInt16(offset, samples[i], true);
        offset += 2;
      }
      
      return new Blob([ view ], {type : 'audio/wav'});
    }
  </script>
  
  <!-- Load the SherpaOnnx WebAssembly module -->
  <script src="/public/sherpaonnx-wasm/sherpa-onnx-tts.js"></script>
  <script src="/public/sherpaonnx-wasm/sherpa-onnx-wasm-main-tts.js"></script>
</body>
</html>
