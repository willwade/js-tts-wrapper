<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SherpaOnnx WebAssembly TTS Wrapper Test</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      line-height: 1.6;
    }
    h1 {
      color: #333;
      border-bottom: 2px solid #eee;
      padding-bottom: 10px;
    }
    .container {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    .card {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    .controls {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    .control-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    label {
      font-weight: bold;
      color: #555;
    }
    textarea {
      width: 100%;
      height: 120px;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      resize: vertical;
    }
    button {
      padding: 10px 15px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      transition: background-color 0.3s;
    }
    button:hover {
      background-color: #45a049;
    }
    button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
    .button-group {
      display: flex;
      gap: 10px;
    }
    .log {
      background-color: #f5f5f5;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 10px;
      height: 200px;
      overflow-y: auto;
      font-family: monospace;
      white-space: pre-wrap;
    }
    .status {
      font-weight: bold;
      margin-top: 10px;
      color: #555;
    }
    .footer {
      margin-top: 30px;
      text-align: center;
      color: #777;
      font-size: 0.9em;
    }
  </style>
</head>
<body>
  <h1>SherpaOnnx WebAssembly TTS Wrapper Test</h1>
  
  <div class="container">
    <div class="card">
      <div class="controls">
        <div class="control-group">
          <label for="text">Text to speak:</label>
          <textarea id="text">Hello, this is a test of the SherpaOnnx WebAssembly text-to-speech engine.</textarea>
        </div>
        
        <div class="button-group">
          <button id="speakButton">Speak</button>
          <button id="stopButton" disabled>Stop</button>
          <button id="downloadButton">Download</button>
          <button id="directTestButton">Direct Test</button>
        </div>
      </div>

      <div class="status" id="status">
        Status: Ready
      </div>

      <div class="log" id="log"></div>
    </div>
  </div>

  <div class="footer">
    Powered by <a href="https://github.com/willwade/js-tts-wrapper" target="_blank">js-tts-wrapper</a> and <a href="https://github.com/k2-fsa/sherpa-onnx" target="_blank">SherpaOnnx</a>
  </div>

  <!-- Load the SherpaOnnx WebAssembly module -->
  <script src="/public/sherpaonnx-wasm/sherpa-onnx-tts.js"></script>
  <script src="/public/sherpaonnx-wasm/sherpa-onnx-wasm-main-tts.js"></script>
  
  <!-- Ensure createOfflineTts is exposed to the global scope -->
  <script>
    // Make sure createOfflineTts is available in the global scope
    if (typeof window.createOfflineTts === 'function') {
      console.log('createOfflineTts is already in the global scope');
    } else if (typeof createOfflineTts === 'function') {
      console.log('Exposing createOfflineTts to the global scope');
      window.createOfflineTts = createOfflineTts;
    } else {
      console.warn('createOfflineTts is not available');
    }
  </script>
  
  <!-- Load the TTS wrapper -->
  <script src="/js-tts-wrapper.browser.bundle.js"></script>

  <script>
    // DOM elements
    const textArea = document.getElementById('text');
    const speakButton = document.getElementById('speakButton');
    const stopButton = document.getElementById('stopButton');
    const downloadButton = document.getElementById('downloadButton');
    const directTestButton = document.getElementById('directTestButton');
    const statusElement = document.getElementById('status');
    const logElement = document.getElementById('log');

    // TTS client
    let ttsClient;
    
    // Audio context
    let audioContext;
    let audioSource;

    // Log messages
    function log(message) {
      const timestamp = new Date().toLocaleTimeString();
      logElement.textContent += `[${timestamp}] ${message}\n`;
      logElement.scrollTop = logElement.scrollHeight;
      console.log(message);
    }

    // Update status
    function updateStatus(message) {
      statusElement.textContent = `Status: ${message}`;
    }

    // Initialize the TTS client
    async function initTTS() {
      try {
        log('Waiting for createOfflineTts to be available...');
        await new Promise(resolve => {
          const checkCreateOfflineTts = () => {
            if (typeof window.createOfflineTts === 'function' && 
                typeof window.Module !== 'undefined' && 
                window.Module.calledRun) {
              log('createOfflineTts is now available and Module is initialized');
              resolve();
            } else {
              log('Waiting for initialization...');
              log(`createOfflineTts available: ${typeof window.createOfflineTts === 'function'}`);
              log(`Module available: ${typeof window.Module !== 'undefined'}`);
              log(`Module.calledRun: ${window.Module?.calledRun}`);
              setTimeout(checkCreateOfflineTts, 500);
            }
          };
          checkCreateOfflineTts();
        });
        
        log('Creating SherpaOnnx WebAssembly TTS client...');
        
        // Create a new SherpaOnnx WebAssembly TTS client
        ttsClient = new SherpaOnnxWasmTTSClient();
        
        log('Initializing WebAssembly module...');
        
        // Initialize the WebAssembly module
        await ttsClient.initializeWasm('/public/sherpaonnx-wasm/sherpa-onnx-wasm-main-tts.js');
        
        log('Loading voices...');
        
        // Get available voices
        const voices = await ttsClient.getVoices();
        log(`Found ${voices.length} voices`);
        
        // Initialize audio context
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        log('Audio context initialized');
        
        updateStatus('Ready');
      } catch (error) {
        log(`Error initializing TTS: ${error.message}`);
        console.error('Error initializing TTS:', error);
        updateStatus('Error: Failed to initialize TTS');
      }
    }

    // Speak text
    async function speak() {
      try {
        const text = textArea.value.trim();
        if (!text) {
          log('No text to speak');
          return;
        }

        if (!ttsClient) {
          log('TTS client not initialized');
          return;
        }

        // Update UI
        updateStatus('Speaking...');
        speakButton.disabled = true;
        stopButton.disabled = false;
        
        log(`Speaking text: "${text}"`);
        
        // Speak the text
        await ttsClient.speak(text, {
          onStart: () => {
            log('Speech started');
          },
          onEnd: () => {
            log('Speech ended');
            updateStatus('Ready');
            speakButton.disabled = false;
            stopButton.disabled = true;
          },
          onWord: (word, start, end) => {
            log(`Word: "${word}" (${start}s - ${end}s)`);
          }
        });
      } catch (error) {
        log(`Error speaking text: ${error.message}`);
        console.error('Error speaking text:', error);
        updateStatus('Error: Failed to speak text');
        speakButton.disabled = false;
        stopButton.disabled = true;
      }
    }

    // Stop speaking
    function stop() {
      if (ttsClient) {
        log('Stopping speech');
        ttsClient.stop();
      }
      
      updateStatus('Ready');
      speakButton.disabled = false;
      stopButton.disabled = true;
    }

    // Download audio
    async function download() {
      try {
        const text = textArea.value.trim();
        if (!text) {
          log('No text to generate audio for');
          return;
        }

        if (!ttsClient) {
          log('TTS client not initialized');
          return;
        }

        // Update UI
        updateStatus('Generating audio file...');
        downloadButton.disabled = true;
        
        log(`Generating audio for text: "${text}"`);
        
        // Generate audio file
        await ttsClient.synthToFile(text, 'speech.wav', 'wav');
        
        log('Audio file generated and download started');
        updateStatus('Ready');
        downloadButton.disabled = false;
      } catch (error) {
        log(`Error generating audio file: ${error.message}`);
        console.error('Error generating audio file:', error);
        updateStatus('Error: Failed to generate audio file');
        downloadButton.disabled = false;
      }
    }
    
    // Direct test
    async function directTest() {
      try {
        const text = textArea.value.trim();
        if (!text) {
          log('No text to test');
          return;
        }
        
        // Update UI
        updateStatus('Running direct test...');
        directTestButton.disabled = true;
        
        log('Testing direct access to createOfflineTts...');
        
        if (typeof window.createOfflineTts !== 'function') {
          throw new Error('createOfflineTts is not available');
        }
        
        if (typeof window.Module === 'undefined') {
          throw new Error('Module is not available');
        }
        
        if (!window.Module.calledRun) {
          throw new Error('Module is not fully initialized');
        }
        
        log('Creating TTS instance directly...');
        const directTts = window.createOfflineTts(window.Module);
        log(`TTS created successfully. Sample rate: ${directTts.sampleRate}, Num speakers: ${directTts.numSpeakers}`);
        
        log(`Generating audio for text: "${text}"`);
        const result = directTts.generate({ text, sid: 0, speed: 1.0 });
        log(`Generated audio with ${result.samples.length} samples at ${result.sampleRate}Hz`);
        
        // Play the audio
        if (!audioContext) {
          audioContext = new (window.AudioContext || window.webkitAudioContext)();
        }
        
        const audioBuffer = audioContext.createBuffer(1, result.samples.length, result.sampleRate);
        audioBuffer.getChannelData(0).set(result.samples);
        
        audioSource = audioContext.createBufferSource();
        audioSource.buffer = audioBuffer;
        audioSource.connect(audioContext.destination);
        
        audioSource.onended = () => {
          log('Audio playback ended');
          updateStatus('Ready');
          directTestButton.disabled = false;
        };
        
        log('Starting audio playback');
        audioSource.start();
      } catch (error) {
        log(`Error in direct test: ${error.message}`);
        console.error('Error in direct test:', error);
        updateStatus('Error: Direct test failed');
        directTestButton.disabled = false;
      }
    }

    // Event listeners
    speakButton.addEventListener('click', speak);
    stopButton.addEventListener('click', stop);
    downloadButton.addEventListener('click', download);
    directTestButton.addEventListener('click', directTest);

    // Initialize TTS when the page loads
    window.addEventListener('DOMContentLoaded', initTTS);
  </script>
</body>
</html>
